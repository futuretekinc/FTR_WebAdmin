{% extends "layout/main.html" %}
{% from "macro/mc_form.html" import render_field, render_form,render_form_noSubmit, render_checkbox_field %}
{% from "macro/mc_header.html" import css_html_table,js_html_table %}
{% from "macro/mc_components.html" import render_multiselect %}
{% from "obm/obm_tables.html" import show_dvtype_table,foo_table %}

<!-- CSS -->
{% block styles %}
{{super()}}
{{css_html_table()}}
<style>
.no-border {
	border:0;
	box-shadow:none; 
}
</style>
{% endblock %}
<!-- CSS -->

<!-- SCRIPTS -->
{% block scripts %}
{{super()}}
{{js_html_table()}}  
<script src="{{url_for('static',filename='assets/js/multiselect/multiselect.js')}}"></script>
<script src="{{url_for('static',filename='assets/js/obm/obm_tables.js')}}"></script>
  
<script type="text/javascript">

function fn_isActiveTab1() {
	if(false == $('#tab-1').hasClass('active')) {
		bootbox.alert("엔드포인트 설정 화면에서는 삭제 할 수 없습니다.");
		return false;
	}
	return true;
}

function fn_onDelete(dvtype) {
	if ($('#tab-1').hasClass('active')) {
		var $form = $('<form></form>');
		$form.attr({'action' : '/obm/devtype_delete'});
		$form.attr({'method' : 'post'});
		$form.appendTo(document.body);
		
		var input_dvType = $('<input type="hidden" name="dv_type" value="'+dvtype+'"/>')
		$form.append(input_dvType);
		$form.submit();
	}
}
 
function fn_onNew() {
	location.href='/obm/devtype'
}

function fn_onSave() {
	var $form = $('#form_id');
	$form.attr({'action' : '/obm/devtype_save'});
	$form.attr({'method' : 'POST'});
	$form.submit();
}

function fn_onUpdate() {
	var $form = $('#form_id');
	$form.attr({'action' : '/obm/devtype_update'});
	$form.attr({'method' : 'POST'});
	$form.submit();
}

/**
 * 디바이스에 속해 있는 모든 엔드포인트 리스트를 가져온다.
 multiselect
 multiselect_to
 */
function fn_loadEntryForDevice(dv_type) {
	var param = {'dv_type' : dv_type }
	return $.getJSON('/obm/devtype_map', param , function(d){
		console.log(d);
		var sel = d['selected'];
		var unsel = d['unselected'];
		var $unsel_combo = $('#multiselect')
		var $sel_combo = $('#multiselect_to')
		//console.log(sel);
		$sel_combo.html('');
		$unsel_combo.html('');
		
		for(var i = 0; i < sel.length; i++) {
			$sel_combo.append('<option>'+sel[i]+'</option>');
		}

		for(var i = 0; i < unsel.length; i++) {
			$unsel_combo.append('<option>'+unsel[i]+'</option>');
		}
	})
}


function fn_updateEntryForDevice(e) {
	
	e.preventDefault();
	
	var dv_type = $('#dv_type').val() || '';
	
	if (dv_type == '') {
		return;
	}
	
	var param = {'dv_type' : $('#dv_type').val() , 'ep_types' : [] };
	var $sel_combo = $('#multiselect_to')
	$sel_combo.find('option').each(function(idx){
		param['ep_types'].push($(this).text());
	});
	$.postJSON('/obm/devtype_map', param , function(d){
		//console.log(d);
	}).done(function(d){
		bootbox.alert("디바이스["+dv_type+"] 엔드포인트 목록이 갱신(저장)되었습니다.");	
	});
}




$(document).ready(function(){
	$.openMenu('M2_13_30');
	show_dvtype_table();
	
	$('#ep_map_update').on('click',fn_updateEntryForDevice);
	
	
	$(document).on('click','.ftr_table_delete',function(e){
		e.preventDefault();
		
		if(false == fn_isActiveTab1()) {
			return;
		}
		
		var key = $(this).attr('key');
		ftr_alert_confirm_normal("엔트리 타입 ["+key+"]를 삭제 하시겠습니까?", function(result) {
			if(false == result) {
				//
				return;
			}
			fn_onDelete(key);
		});
	});
	
	$('#form_new').click(fn_onNew);
	$('#form_save').click(fn_onSave);
	$('#form_update').click(fn_onUpdate);
	
	$(document).on('click','.table_view tr',function(e){
		e.preventDefault();
		
		var $this = $(this);
		function _text(obj, index) {
			return $(obj).find('td:eq('+index+')').text();
		}
		
		var dv_type = _text($this,0);
		var load = fn_loadEntryForDevice(dv_type); // 자식 엔트리 목록 업데이트 
		load.done(function(d){
			var desc = d['dv_type']['dv_desc'];
			var names = [ 
				'dv_type' 
				, 'dv_name' 
				, 'dv_location' 
				, 'dv_timeout' 
				, 'dv_option' 
				, 'dv_protocol' ];
			
			for(var i = 0; i < names.length; i++) {
				$('#form_id [name='+names[i]+']').val(_text($this,i));
				$('#info_id [name='+names[i]+']').val(_text($this,i));
			}

			$('#form_id [name=dv_desc]').val(desc);
			$('#info_id [name=dv_desc]').val(desc);
			
		});
   });
	
	/** http://www.jqueryscript.net/form/Two-side-Multi-Select-Plugin-with-jQuery-multiselect-js.html */
	$('#multiselect').multiselect();
	
	$('#tab2').on('click',function(e){
		e.preventDefault();
		$('.table_view tr:eq(0) td:eq(1)').trigger('click');
	});
});

$(document).ready(function(){
	$('#btn-show').on('click', function(){
	      var container = $('#example-container').clone();
	      container.find('table').attr('id', 'example');

	      var box = bootbox.dialog({
	        show: false,
	        message: container.html(),
	        title: "DataTables in a Bootbox",
	        buttons: {
	          ok: {
	            label: "OK",
	            className: "btn-primary",
	            callback: function() {
	              console.log('OK Button');
	            }
	          },
	          cancel: {
	            label: "Cancel",
	            className: "btn-default"
	          }
	        }
	      });
	      
	      box.on("shown.bs.modal", function() {
	         $('#example').DataTable(); 
	      });
	      
	      box.modal('show'); 
	   });
});


</script>

{% endblock %}
<!-- SCRIPTS -->

<!-- title -->
{% block title %}{{title|safe}}{% endblock %}

<!-- header -->
{% block page_header %}
{{ render_breadscrumb(title=title,sub_1="디바이스관리",sub_2="디바이스타입관리") }}
{% endblock %}

<!-- main block -->
{% block page_main %}
{{super()}}
<!-- BEGIN-MAIN -->
<div class="row">
<div class="col-lg-12">


<div class="tabs-container">
	<ul class="nav nav-tabs">
		<li id='tab1' class="active"><a data-toggle="tab" href="#tab-1"
			aria-expanded="true"><i class="fa fa-microchip" aria-hidden="true"></i> 디바이스타입 관리</a></li>
		<li id='tab2' class=""><a data-toggle="tab" href="#tab-2"
			aria-expanded="false"><i class="fa fa-thermometer-half" aria-hidden="true"></i> 엔드포인트 설정</a></li> 
	</ul>
	<div class="tab-content">
		<!-- TAB1 -->
		<div id="tab-1" class="tab-pane active">
			<div class="panel-body">
				<div class="row">
				{% call render_form_noSubmit(form, form_id='form_id') %}
					<div class="col-md-6">
						<div class="col-xs-6">{{ render_field(form.dv_type) }}</div>
						<div class="col-xs-6">{{ render_field(form.dv_name) }}</div>
						<div class="col-xs-12">{{ render_field(form.dv_desc) }}</div>
					</div>
					<div class="col-md-6">
						<div class="col-xs-6">{{ render_field(form.dv_location) }}</div>
						<div class="col-xs-6">{{ render_field(form.dv_timeout) }}</div>
						<div class="col-xs-6">{{ render_field(form.dv_option) }}</div>
						<div class="col-xs-6">{{ render_field(form.dv_protocol) }}</div>
					</div>
				</div>
				{% endcall %}
			<div class="text-right">
				<button id="btn-show" class='btn btn-default'>test</button>
				<button id="form_new" class='btn btn-default'>신규</button>
				<button id="form_update" class='btn btn-primary'>수정</button>
				<button id="form_save" class='btn btn-success'>저장</button>
			</div>				
			</div>
		</div>
		<!-- TAB1 -->
		<!-- TAB2 -->
		<div id="tab-2" class="tab-pane">
			<div class="panel-body">
				<p>
				<strong>디바이스 정보</strong>
				<div class="col-md-8 border-right">
					<!-- <strong>엔드포인트 설정</strong> -->
					<p>{{ render_multiselect(epTypes) }}</p>
					<div class="text-right">
						<button id="ep_map_update" class='btn btn-primary'>저장</button> 
					</div>						
				</div>
				<div class="col-md-4" id='info_id'>
					<p>
						<div class="col-xs-12">
							<div class="form-group no-border ">
            					<label for="dv_type" class="control-label"><label for="dv_type">타입</label></label>
        						<input class="form-control input-sm" id="dv_type" name="dv_type" style="text-transform:uppercase;border:0" type="text" readonly> 
							</div>
						</div>
						<div class="col-xs-12">
							<div class="form-group no-border ">
            					<label for="dv_type" class="control-label"><label for="dv_name">이름</label></label>
        						<input class="form-control input-sm" id="dv_name" name="dv_name" style="border:0" type="text" readonly> 
							</div>
						</div>
						<div class="col-xs-12">
							<div class="form-group no-border ">
            					<label for="dv_desc" class="control-label"><label for="dv_desc">설명</label></label>
        						<textarea class="form-control input-sm" id="dv_desc" name="dv_desc" style="border:0" readonly></textarea> 
    						</div>
						</div>

					</p>
				</div>
				</p>
			</div>
		</div>
		<!-- TAB2 -->
	</div>
</div>

<div class="col-lg-12 m-xs">

</div>


</div>
<!-- TABLE -->
<div class="col-lg-12">
	<div class="ibox-content m-b-sm border-bottom">
		{{ show_dvtype_table() }}
	</div>
</div>
<!-- TABLE -->
</div>
















<div id="example-container" style="display:none">
   <table class="display" cellspacing="0" width="100%">
     <thead>
       <tr>
         <th>Name</th>
         <th>Position</th>
         <th>Office</th>
         <th>Age</th>
         <th>Start date</th>
         <th>Salary</th>
       </tr>
     </thead>
   
     <tfoot>
       <tr>
         <th>Name</th>
         <th>Position</th>
         <th>Office</th>
         <th>Age</th>
         <th>Start date</th>
         <th>Salary</th>
       </tr>
     </tfoot>
   
     <tbody>
       <tr>
         <td>Tiger Nixon</td>
         <td>System Architect</td>
         <td>Edinburgh</td>
         <td>61</td>
         <td>2011/04/25</td>
         <td>$320,800</td>
       </tr>
       <tr>
         <td>Garrett Winters</td>
         <td>Accountant</td>
         <td>Tokyo</td>
         <td>63</td>
         <td>2011/07/25</td>
         <td>$170,750</td>
       </tr>
       <tr>
         <td>Ashton Cox</td>
         <td>Junior Technical Author</td>
         <td>San Francisco</td>
         <td>66</td>
         <td>2009/01/12</td>
         <td>$86,000</td>
       </tr>
       <tr>
         <td>Cedric Kelly</td>
         <td>Senior Javascript Developer</td>
         <td>Edinburgh</td>
         <td>22</td>
         <td>2012/03/29</td>
         <td>$433,060</td>
       </tr>
       <tr>
         <td>Airi Satou</td>
         <td>Accountant</td>
         <td>Tokyo</td>
         <td>33</td>
         <td>2008/11/28</td>
         <td>$162,700</td>
       </tr>
       <tr>
         <td>Brielle Williamson</td>
         <td>Integration Specialist</td>
         <td>New York</td>
         <td>61</td>
         <td>2012/12/02</td>
         <td>$372,000</td>
       </tr>
       <tr>
         <td>Herrod Chandler</td>
         <td>Sales Assistant</td>
         <td>San Francisco</td>
         <td>59</td>
         <td>2012/08/06</td>
         <td>$137,500</td>
       </tr>
       <tr>
         <td>Rhona Davidson</td>
         <td>Integration Specialist</td>
         <td>Tokyo</td>
         <td>55</td>
         <td>2010/10/14</td>
         <td>$327,900</td>
       </tr>
       <tr>
         <td>Colleen Hurst</td>
         <td>Javascript Developer</td>
         <td>San Francisco</td>
         <td>39</td>
         <td>2009/09/15</td>
         <td>$205,500</td>
       </tr>
       <tr>
         <td>Sonya Frost</td>
         <td>Software Engineer</td>
         <td>Edinburgh</td>
         <td>23</td>
         <td>2008/12/13</td>
         <td>$103,600</td>
       </tr>
       <tr>
         <td>Jena Gaines</td>
         <td>Office Manager</td>
         <td>London</td>
         <td>30</td>
         <td>2008/12/19</td>
         <td>$90,560</td>
       </tr>
       <tr>
         <td>Quinn Flynn</td>
         <td>Support Lead</td>
         <td>Edinburgh</td>
         <td>22</td>
         <td>2013/03/03</td>
         <td>$342,000</td>
       </tr>
       <tr>
         <td>Charde Marshall</td>
         <td>Regional Director</td>
         <td>San Francisco</td>
         <td>36</td>
         <td>2008/10/16</td>
         <td>$470,600</td>
       </tr>
       <tr>
         <td>Haley Kennedy</td>
         <td>Senior Marketing Designer</td>
         <td>London</td>
         <td>43</td>
         <td>2012/12/18</td>
         <td>$313,500</td>
       </tr>
       <tr>
         <td>Tatyana Fitzpatrick</td>
         <td>Regional Director</td>
         <td>London</td>
         <td>19</td>
         <td>2010/03/17</td>
         <td>$385,750</td>
       </tr>
       <tr>
         <td>Michael Silva</td>
         <td>Marketing Designer</td>
         <td>London</td>
         <td>66</td>
         <td>2012/11/27</td>
         <td>$198,500</td>
       </tr>
       <tr>
         <td>Paul Byrd</td>
         <td>Chief Financial Officer (CFO)</td>
         <td>New York</td>
         <td>64</td>
         <td>2010/06/09</td>
         <td>$725,000</td>
       </tr>
       <tr>
         <td>Gloria Little</td>
         <td>Systems Administrator</td>
         <td>New York</td>
         <td>59</td>
         <td>2009/04/10</td>
         <td>$237,500</td>
       </tr>
       <tr>
         <td>Bradley Greer</td>
         <td>Software Engineer</td>
         <td>London</td>
         <td>41</td>
         <td>2012/10/13</td>
         <td>$132,000</td>
       </tr>
       <tr>
         <td>Dai Rios</td>
         <td>Personnel Lead</td>
         <td>Edinburgh</td>
         <td>35</td>
         <td>2012/09/26</td>
         <td>$217,500</td>
       </tr>
       <tr>
         <td>Jenette Caldwell</td>
         <td>Development Lead</td>
         <td>New York</td>
         <td>30</td>
         <td>2011/09/03</td>
         <td>$345,000</td>
       </tr>
       <tr>
         <td>Yuri Berry</td>
         <td>Chief Marketing Officer (CMO)</td>
         <td>New York</td>
         <td>40</td>
         <td>2009/06/25</td>
         <td>$675,000</td>
       </tr>
       <tr>
         <td>Caesar Vance</td>
         <td>Pre-Sales Support</td>
         <td>New York</td>
         <td>21</td>
         <td>2011/12/12</td>
         <td>$106,450</td>
       </tr>
       <tr>
         <td>Doris Wilder</td>
         <td>Sales Assistant</td>
         <td>Sidney</td>
         <td>23</td>
         <td>2010/09/20</td>
         <td>$85,600</td>
       </tr>
       <tr>
         <td>Angelica Ramos</td>
         <td>Chief Executive Officer (CEO)</td>
         <td>London</td>
         <td>47</td>
         <td>2009/10/09</td>
         <td>$1,200,000</td>
       </tr>
       <tr>
         <td>Gavin Joyce</td>
         <td>Developer</td>
         <td>Edinburgh</td>
         <td>42</td>
         <td>2010/12/22</td>
         <td>$92,575</td>
       </tr>
       <tr>
         <td>Jennifer Chang</td>
         <td>Regional Director</td>
         <td>Singapore</td>
         <td>28</td>
         <td>2010/11/14</td>
         <td>$357,650</td>
       </tr>
       <tr>
         <td>Brenden Wagner</td>
         <td>Software Engineer</td>
         <td>San Francisco</td>
         <td>28</td>
         <td>2011/06/07</td>
         <td>$206,850</td>
       </tr>
       <tr>
         <td>Fiona Green</td>
         <td>Chief Operating Officer (COO)</td>
         <td>San Francisco</td>
         <td>48</td>
         <td>2010/03/11</td>
         <td>$850,000</td>
       </tr>
       <tr>
         <td>Shou Itou</td>
         <td>Regional Marketing</td>
         <td>Tokyo</td>
         <td>20</td>
         <td>2011/08/14</td>
         <td>$163,000</td>
       </tr>
       <tr>
         <td>Michelle House</td>
         <td>Integration Specialist</td>
         <td>Sidney</td>
         <td>37</td>
         <td>2011/06/02</td>
         <td>$95,400</td>
       </tr>
       <tr>
         <td>Suki Burks</td>
         <td>Developer</td>
         <td>London</td>
         <td>53</td>
         <td>2009/10/22</td>
         <td>$114,500</td>
       </tr>
       <tr>
         <td>Prescott Bartlett</td>
         <td>Technical Author</td>
         <td>London</td>
         <td>27</td>
         <td>2011/05/07</td>
         <td>$145,000</td>
       </tr>
       <tr>
         <td>Gavin Cortez</td>
         <td>Team Leader</td>
         <td>San Francisco</td>
         <td>22</td>
         <td>2008/10/26</td>
         <td>$235,500</td>
       </tr>
       <tr>
         <td>Martena Mccray</td>
         <td>Post-Sales support</td>
         <td>Edinburgh</td>
         <td>46</td>
         <td>2011/03/09</td>
         <td>$324,050</td>
       </tr>
       <tr>
         <td>Unity Butler</td>
         <td>Marketing Designer</td>
         <td>San Francisco</td>
         <td>47</td>
         <td>2009/12/09</td>
         <td>$85,675</td>
       </tr>
       <tr>
         <td>Howard Hatfield</td>
         <td>Office Manager</td>
         <td>San Francisco</td>
         <td>51</td>
         <td>2008/12/16</td>
         <td>$164,500</td>
       </tr>
       <tr>
         <td>Hope Fuentes</td>
         <td>Secretary</td>
         <td>San Francisco</td>
         <td>41</td>
         <td>2010/02/12</td>
         <td>$109,850</td>
       </tr>
       <tr>
         <td>Vivian Harrell</td>
         <td>Financial Controller</td>
         <td>San Francisco</td>
         <td>62</td>
         <td>2009/02/14</td>
         <td>$452,500</td>
       </tr>
       <tr>
         <td>Timothy Mooney</td>
         <td>Office Manager</td>
         <td>London</td>
         <td>37</td>
         <td>2008/12/11</td>
         <td>$136,200</td>
       </tr>
       <tr>
         <td>Jackson Bradshaw</td>
         <td>Director</td>
         <td>New York</td>
         <td>65</td>
         <td>2008/09/26</td>
         <td>$645,750</td>
       </tr>
       <tr>
         <td>Olivia Liang</td>
         <td>Support Engineer</td>
         <td>Singapore</td>
         <td>64</td>
         <td>2011/02/03</td>
         <td>$234,500</td>
       </tr>
       <tr>
         <td>Bruno Nash</td>
         <td>Software Engineer</td>
         <td>London</td>
         <td>38</td>
         <td>2011/05/03</td>
         <td>$163,500</td>
       </tr>
       <tr>
         <td>Sakura Yamamoto</td>
         <td>Support Engineer</td>
         <td>Tokyo</td>
         <td>37</td>
         <td>2009/08/19</td>
         <td>$139,575</td>
       </tr>
       <tr>
         <td>Thor Walton</td>
         <td>Developer</td>
         <td>New York</td>
         <td>61</td>
         <td>2013/08/11</td>
         <td>$98,540</td>
       </tr>
       <tr>
         <td>Finn Camacho</td>
         <td>Support Engineer</td>
         <td>San Francisco</td>
         <td>47</td>
         <td>2009/07/07</td>
         <td>$87,500</td>
       </tr>
       <tr>
         <td>Serge Baldwin</td>
         <td>Data Coordinator</td>
         <td>Singapore</td>
         <td>64</td>
         <td>2012/04/09</td>
         <td>$138,575</td>
       </tr>
       <tr>
         <td>Zenaida Frank</td>
         <td>Software Engineer</td>
         <td>New York</td>
         <td>63</td>
         <td>2010/01/04</td>
         <td>$125,250</td>
       </tr>
       <tr>
         <td>Zorita Serrano</td>
         <td>Software Engineer</td>
         <td>San Francisco</td>
         <td>56</td>
         <td>2012/06/01</td>
         <td>$115,000</td>
       </tr>
       <tr>
         <td>Jennifer Acosta</td>
         <td>Junior Javascript Developer</td>
         <td>Edinburgh</td>
         <td>43</td>
         <td>2013/02/01</td>
         <td>$75,650</td>
       </tr>
       <tr>
         <td>Cara Stevens</td>
         <td>Sales Assistant</td>
         <td>New York</td>
         <td>46</td>
         <td>2011/12/06</td>
         <td>$145,600</td>
       </tr>
       <tr>
         <td>Hermione Butler</td>
         <td>Regional Director</td>
         <td>London</td>
         <td>47</td>
         <td>2011/03/21</td>
         <td>$356,250</td>
       </tr>
       <tr>
         <td>Lael Greer</td>
         <td>Systems Administrator</td>
         <td>London</td>
         <td>21</td>
         <td>2009/02/27</td>
         <td>$103,500</td>
       </tr>
       <tr>
         <td>Jonas Alexander</td>
         <td>Developer</td>
         <td>San Francisco</td>
         <td>30</td>
         <td>2010/07/14</td>
         <td>$86,500</td>
       </tr>
       <tr>
         <td>Shad Decker</td>
         <td>Regional Director</td>
         <td>Edinburgh</td>
         <td>51</td>
         <td>2008/11/13</td>
         <td>$183,000</td>
       </tr>
       <tr>
         <td>Michael Bruce</td>
         <td>Javascript Developer</td>
         <td>Singapore</td>
         <td>29</td>
         <td>2011/06/27</td>
         <td>$183,000</td>
       </tr>
       <tr>
         <td>Donna Snider</td>
         <td>Customer Support</td>
         <td>New York</td>
         <td>27</td>
         <td>2011/01/25</td>
         <td>$112,000</td>
       </tr>
     </tbody>
   </table>
</div>







<!-- END-MAIN -->

{% endblock page_main %}


